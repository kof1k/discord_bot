#!/bin/bash

# VPS Deployment Script –¥–ª—è Music Bot
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./deploy.sh

set -e  # –ó—É–ø–∏–Ω–∫–∞ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

echo "üöÄ –†–æ–∑–ø–æ—á–∏–Ω–∞—é deployment –Ω–∞ VPS..."

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É –ø–æ–º–∏–ª–æ–∫
error() {
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞: $1${NC}"
    exit 1
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É —É—Å–ø—ñ—Ö—É
success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
info() {
    echo -e "${YELLOW}‚ÑπÔ∏è  $1${NC}"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ .env —Ñ–∞–π–ª—É
if [ ! -f .env ]; then
    error ".env —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—ñ—Ç—å –π–æ–≥–æ –∑ .env.example"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PostgreSQL
info "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ PostgreSQL..."
if ! psql -h localhost -U postgres -lqt | cut -d \| -f 1 | grep -qw music_bot; then
    error "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö music_bot –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –ó–∞–ø—É—Å—Ç—ñ—Ç—å setup-vps.sh —Å–ø–æ—á–∞—Ç–∫—É"
fi
success "PostgreSQL –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É
info "–û—Ç—Ä–∏–º–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –∑–º—ñ–Ω..."
git pull origin $(git branch --show-current) || error "–ü–æ–º–∏–ª–∫–∞ git pull"
success "–ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ"

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
npm install --production || error "–ü–æ–º–∏–ª–∫–∞ npm install"
success "Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

info "–û–Ω–æ–≤–ª–µ–Ω–Ω—è Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
pip3 install --upgrade yt-dlp || error "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è yt-dlp"
success "Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ"

# –ú—ñ–≥—Ä–∞—Ü—ñ—è –ë–î (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
info "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ë–î..."
node scripts/init-database.js || info "–ë–î –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ"

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π
info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π..."
mkdir -p logs music downloads
chmod 755 logs music downloads
success "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó —Å—Ç–≤–æ—Ä–µ–Ω–æ"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç—ñ–≤ —á–µ—Ä–µ–∑ PM2..."

if pm2 list | grep -q "discord-bot"; then
    pm2 reload discord-bot --update-env || error "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É discord-bot"
    pm2 reload telegram-bot --update-env || error "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É telegram-bot"
    success "–ë–æ—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
else
    pm2 start ecosystem.config.js || error "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É PM2"
    pm2 save || error "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è PM2"
    success "–ë–æ—Ç–∏ –∑–∞–ø—É—â–µ–Ω–æ"
fi

# –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç—É—Å
info "–°—Ç–∞—Ç—É—Å –±–æ—Ç—ñ–≤:"
pm2 list

# –ü–æ–∫–∞–∑—É—î–º–æ –ª–æ–≥–∏
info "–û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
echo ""
pm2 logs --lines 10 --nostream

echo ""
success "üéâ Deployment –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
info "–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ª–æ–≥—ñ–≤: pm2 logs"
info "–î–ª—è —Å—Ç–∞—Ç—É—Å—É: pm2 status"
info "–î–ª—è –º–æ–Ω—ñ—Ç–æ—Ä—É: pm2 monit"
